new Vue({delimiters:["${","}"],el:"#chatPage",data:{socket:"",user_list:[],chat_list:[],current_obj:"",user_msg:"",chat_page:1,page_flag:!0},created:function(){},mounted:function(){var t=this;$(function(){t.init()})},filters:{dateMd:dateMd},methods:{init:function(){this.socketFun(),this.getContacts(),this.user_msg=JSON.parse($("#user_msg").val()),this.scrolltoTop()},socketFun:function(){var s=this;if(-1!=window.location.host.indexOf("localhost"))var t="127.0.0.1:3001";else t="taohuayuanskill.com";loadScript("https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js",function(){s.socket=io.connect(t,{path:"/socket"}),s.socket.on("connect",function(){s.socket.emit("join",getCookie("userId"))}),s.socket.on("server_message",function(t){var e=JSON.parse(t);s.receiveMsg(e)})})},watchDiv:function(t){this.current_obj.curr_content=$(t.currentTarget).text()},scrolltoBottom:function(){var t=document.querySelector(".chat-message"),e=document.querySelector(".im-list");this.$nextTick(function(){t.scrollTop=e.offsetHeight})},scrolltoTop:function(){var t=this,e=document.querySelector(".chat-message");e.addEventListener("scroll",function(){e.scrollTop<80&&t.page_flag&&(t.chat_page+=1,t.page_falg=!1,t.getRecord())})},sendMsg:function(){if(!this.current_obj.curr_content.length)return!1;$("#chat-input").text("");var t={from:getCookie("userId"),to:this.current_obj.relation_id,text:this.current_obj.curr_content,type:1};t=JSON.stringify(t),this.socket.emit("private_message",t),this.chat_list.push({head:this.user_msg.head,content:this.current_obj.curr_content,belong:1}),this.scrolltoBottom(),this.current_obj.prev_content="",this.current_obj.curr_content=""},receiveMsg:function(o){var n=this;if(o.from==this.current_obj.relation_id)this.chat_list.push({head:this.current_obj.head,content:o.text,belong:2}),this.scrolltoBottom();else{var r=0;this.user_list.forEach(function(t,e){if(t.relation_id==o.from){var s=n.user_list[e];return n.user_list.splice(e,1),n.user_list.unshift(s),!(r=1)}}),0==r&&$.ajax({url:"/api/getContacts/single",type:"get",data:{relation_id:o.from},success:function(t){if(200==t.code){var e=t.body;e.prev_content="",e.curr_content="",n.user_list.unshift(e)}else n.$message.warning(t.body)},error:function(){n.$message.warning("网络波动，请稍后重试")}})}didiPlay()},getContacts:function(){var e=this;$.ajax({url:"/api/getContacts/list",type:"get",success:function(t){200==t.code&&(t.body.length&&t.body.forEach(function(t){t.prev_content="",t.curr_content="",e.user_list.push(t)}))},error:function(){e.$message.error("当前网络不佳，请稍后重试")}})},getRecord:function(){var r=this;$.ajax({url:"/api/getChat/list",type:"get",data:{master:this.user_msg.id,guest:this.current_obj.relation_id,page:this.chat_page},success:function(n){if(200==n.code){var t=n.body.list;t.length?(t.forEach(function(t){if(t.from==r.user_msg.id)var e=r.user_msg.head,s=1;else e=n.body.user_msg.head,s=2;var o={head:e,content:t.msg,belong:s};r.chat_list.unshift(o)}),1==r.chat_page&&r.scrolltoBottom(),t.length<20?r.page_flag=!1:r.page_flag=!0):r.page_flag=!1}else r.$message.warning(n.body)},error:function(){r.$message.warning("当前网络波动，请稍后重试"),r.page_flag=!1}})},cutchatPerson:function(t){this.current_obj=this.user_list[t]}},watch:{current_obj:{handler:function(t,e){this.chat_list=[],this.chat_page=1,this.page_flag=!0,this.getRecord()},deep:!1}}});