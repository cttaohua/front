new Vue({el:"#writePage",data:{word_id:"",draft_id:"",title:"",coverUrl:"",editor:"",create_flag:!1,new_classify:"",c_first:[],c_first_value:"",c_second:[],c_second_value:"",dialogVisible:!1,cover_page:1,cover_list:[],cover_load:1},created:function(){},mounted:function(){var t=this;$(function(){t.init(),t.getC_first(),t.getCoverList(),t.createEditor(),t.transformImg(),t.roll()})},methods:{init:function(){var t=$('input[name="word_msg"]').val();t.length&&("edit"==(t=JSON.parse(t)).type?this.word_id=t.id:this.draft_id=t.id,this.title=t.title,this.coverUrl=t.cover,t.first_id&&(this.c_first_value=t.first_id,t.classify_id&&this.c_first_callback(this.c_first_value,t.classify_id)),void 0!==t.new_classify&&t.new_classify&&(this.new_classify=t.new_classify,this.create_flag=!0))},show_create:function(){this.create_flag=!0},getC_first:function(){var i=this;$.ajax({url:"/api/getC_first",type:"get",dataType:"json",success:function(t){if(200==t.code)for(var e=0;e<t.body.length;e++)i.c_first.push({value:t.body[e].id,label:t.body[e].value})}})},c_first_callback:function(t,i){var s=this;s.c_second_value="",$.ajax({url:"/api/getC_second",type:"get",data:{parent_id:t},dataType:"json",success:function(t){if(200==t.code){s.c_second=[];for(var e=0;e<t.body.length;e++)s.c_second.push({value:t.body[e].id,label:t.body[e].value});null!=i&&(s.c_second_value=i)}else s.c_second=[]}})},createEditor:function(){var t=window.wangEditor,s=this;this.editor=new t("#editor-title","#editor-content"),this.editor.customConfig.uploadImgServer="/api/upload/acticle",this.editor.customConfig.uploadTimeout=1e8,this.editor.customConfig.customAlert=function(t){s.$message.error(t)},this.editor.create(),this.editor.customConfig.uploadImgHooks={before:function(t,e,i){},success:function(t,e,i){},fail:function(t,e,i){s.$message.error("图片加载失败")},error:function(t,e){s.$message.error("图片上传失败")},timeout:function(t,e){s.$message.error("图片上传超时")}}},transformImg:function(){var s=this,t=document.getElementById("fileSelect"),e=document.getElementById("upload_file");t.addEventListener("click",function(t){e&&e.click(),t&&t.preventDefault?t.preventDefault():window.event.returnValue=!1},!1),$("#upload_file").on("change",function(t){var e=t.target.files[0],i=new FileReader;i.readAsDataURL(e),i.onloadend=function(){var t=i.result;s.coverUrl=t}})},publish:function(t,e){var i=e.substring(0,100)+"...",s={word_id:this.word_id,title:this.title,cover:this.coverUrl?this.coverUrl:"",c_first_id:this.c_first_value,c_second_id:this.c_second_value,newclassify:this.new_classify,content:t,text:e,abs:i,word_num:e.length,draft_id:this.draft_id},o=this;$.ajax({url:"/api/article",type:"post",dataType:"json",data:s,success:function(t){200!=t.code?o.$message.warning(t.body):window.location.href=t.body},error:function(){o.$message.error("当前网络不佳，请稍后重试")}})},comfirm:function(){var t=this;if(!this.title.length)return this.$message({message:"请输入文章标题",type:"warning"}),!1;var e=this.editor.txt.html(),i=this.editor.txt.text();if("<p><br></p>"==e)return this.$message({message:"请输入文章内容",type:"warning"}),!1;if(""==this.c_first_value)return this.$message({message:"请选择一级分类",type:"warning"}),!1;if(this.new_classify)this.$confirm("新增分类的文章不会立即发布，通过审核后才会发布","提示",{confirmButtonText:"继续发布",cancelButtonText:"暂不发布",type:"info"}).then(function(){t.publish(e,i)});else{if(!this.c_second_value)return this.$message({message:"请选择二级分类",type:"warning"}),!1;this.publish(e,i)}},saveDraft:function(){var e=this,t=this.editor.txt.html(),i=this.editor.txt.text();if("<p><br></p>"==t)return this.$message({message:"请输入文章内容",type:"warning"}),!1;var s=i.substring(0,100)+"...";this.title||(this.title=dateYmd((new Date).getTime()));var o={draft_id:this.draft_id,title:this.title,cover:this.coverUrl?this.coverUrl:"",c_first_id:this.c_first_value,c_second_id:this.c_second_value,new_classify:this.new_classify,content:t,text:i,abs:s,word_num:i.length};$.ajax({url:"/api/save/draft",type:"post",dataType:"json",data:o,success:function(t){200!=t.code?e.$message.warning(t.body):window.location.href=t.body},error:function(){e.$message.error("当前网络不佳，请稍后重试")}})},roll:function(){var s=$(".w-e-toolbar");$(window).scroll(function(){var t=s[0].offsetTop,e=t+630,i=$(window).scrollTop();t<i&&i<e?s.addClass("fixed"):s.removeClass("fixed")})},getCoverList:function(){var i=this;$.ajax({url:"/api/cover/list",type:"get",data:{page:this.cover_page},success:function(t){if(200==t.code){var e=t.body.list;e.length<10?i.cover_load=2:i.cover_load=1,i.cover_list=i.cover_list.concat(e)}},error:function(){}})},loadCover:function(){this.cover_page+=1,this.getCoverList()},chooseCover:function(t){this.coverUrl=t,this.dialogVisible=!1}}});